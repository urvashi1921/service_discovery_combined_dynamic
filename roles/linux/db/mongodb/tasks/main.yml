---
#################################################################
# MongoDB Discovery Role Tasks (Linux)
#################################################################

# ========================================
# STEP 0: Take a single snapshot of all processes
# ========================================
- name: Capture full process list once
  shell: ps auxww
  register: ps_snapshot
  changed_when: false
  failed_when: false

# ========================================
# Detect network tool once
# ========================================
- name: Detect network tool
  shell: |
    if command -v ss >/dev/null 2>&1; then echo "ss"
    elif command -v netstat >/dev/null 2>&1; then echo "netstat"
    elif command -v lsof >/dev/null 2>&1; then echo "lsof"
    else echo "none"; fi
  register: network_tool
  changed_when: false
  failed_when: false

# ========================================
# STEP 1: Extract MongoDB processes from snapshot
# ========================================
- name: Extract MongoDB processes
  shell: |
    echo "{{ ps_snapshot.stdout }}" | grep -E '[m]ongod' | awk '{print $2":"$11}' | sort -u
  register: running_mongodb_processes
  changed_when: false
  failed_when: false

# ========================================
# STEP 2: Extract unique binary paths
# ========================================
- name: Extract unique binaries
  shell: |
    echo "{{ ps_snapshot.stdout }}" | grep -E '[m]ongod' | awk '{print $11}' | sort -u
  register: unique_binaries_raw
  changed_when: false
  failed_when: false

- name: Validate unique binaries
  shell: |
    echo "{{ unique_binaries_raw.stdout }}" | tr ' ' '\n' | while read bin; do
      if [ -x "$bin" ] && [ -f "$bin" ]; then
        echo "$bin"
      fi
    done
  register: unique_binaries
  changed_when: false
  failed_when: false

- name: Set unique binaries fact
  set_fact:
    mongodb_unique_binaries: "{{ unique_binaries.stdout_lines | default([]) }}"

# ========================================
# STEP 3: Collect metadata for each binary
# ========================================
- name: Collect all data for each unique binary
  shell: |
    BINARY="{{ item }}"
    PIDS=$(echo "{{ ps_snapshot.stdout }}" | grep -E '[m]ongod' | awk -v bin="$BINARY" '$11 == bin {print $2}' | paste -sd, -)

    VERSION="unknown"
    if [ -x "$BINARY" ]; then
      VERSION=$($BINARY --version 2>/dev/null | grep -oP 'db version v\K[0-9]+\.[0-9]+\.[0-9]+' | head -1)
    fi
    [ -z "$VERSION" ] && VERSION="unknown"

    CONFIG_PATH=""
    DBPATH=""
    if [ -n "$PIDS" ]; then
      FIRST_PID=$(echo $PIDS | cut -d, -f1)
      FULL_CMD=$(echo "{{ ps_snapshot.stdout }}" | grep " $FIRST_PID ")
      CONFIG_PATH=$(echo "$FULL_CMD" | grep -oP '(\-\-config=|(?<=-f ))\K[^ ]+' | head -1)
      [ -z "$CONFIG_PATH" ] && for conf in /etc/mongod.conf /etc/mongodb.conf; do [ -f "$conf" ] && CONFIG_PATH="$conf" && break; done
      DBPATH=$(echo "$FULL_CMD" | grep -oP '\-\-dbpath=\K[^ ]+' | head -1)
      if [ -z "$DBPATH" ] && [ -f "$CONFIG_PATH" ]; then
        DBPATH=$(grep -E '^\s*dbPath:' "$CONFIG_PATH" 2>/dev/null | awk '{print $2}' | tr -d '"' | tr -d "'")
      fi
    fi

    [ -z "$CONFIG_PATH" ] && CONFIG_PATH="not-found"
    [ -z "$DBPATH" ] && DBPATH="/var/lib/mongo"

    PORTS=""
    case "{{ network_tool.stdout }}" in
      ss)
        for pid in $(echo $PIDS | tr ',' ' '); do
          PORTS="$PORTS $(ss -ltnp 2>/dev/null | grep "pid=$pid" | awk '{print $4}' | awk -F: '{print $NF}')"
        done ;;
      netstat)
        for pid in $(echo $PIDS | tr ',' ' '); do
          PORTS="$PORTS $(netstat -tulnp 2>/dev/null | grep "$pid/" | awk '{print $4}' | awk -F: '{print $NF}')"
        done ;;
      lsof)
        for pid in $(echo $PIDS | tr ',' ' '); do
          PORTS="$PORTS $(lsof -p $pid -i -P -n 2>/dev/null | awk '{print $9}' | awk -F: '{print $2}')"
        done ;;
    esac
    PORTS=$(echo $PORTS | tr ' ' '\n' | grep -E '^[0-9]+$' | sort -u | paste -sd, -)
    [ -z "$PORTS" ] && PORTS="none"

    LOGPATH=""
    if [ -f "$CONFIG_PATH" ] && [ "$CONFIG_PATH" != "not-found" ]; then
      LOGPATH=$(grep -E '^\s*path:' "$CONFIG_PATH" 2>/dev/null | awk '{print $2}' | tr -d '"' | tr -d "'")
    fi
    [ -z "$LOGPATH" ] && LOGPATH="/var/log/mongodb/mongod.log"

    BIN_DIR=$(dirname "$BINARY")
    echo "BINARY=$BINARY|||PIDS=$PIDS|||VERSION=$VERSION|||CONFIG=$CONFIG_PATH|||DBPATH=$DBPATH|||PORTS=$PORTS|||LOGPATH=$LOGPATH|||BINDIR=$BIN_DIR"
  args:
    executable: /bin/bash
  register: mongodb_data_collection
  changed_when: false
  failed_when: false
  loop: "{{ mongodb_unique_binaries }}"
  when: mongodb_unique_binaries | length > 0

# ========================================
# STEP 4: Parse into JSON
# ========================================
- name: Initialize discovery array
  set_fact:
    discovery_array: []

- name: Parse each instance
  set_fact:
    discovery_array: "{{ discovery_array + [json_instance] }}"
  vars:
    data_line: "{{ item.stdout }}"
    binary_path: "{{ data_line | regex_search('BINARY=([^|]+)', '\\1') | first }}"
    pids_raw: "{{ data_line | regex_search('PIDS=([^|]+)', '\\1') | first }}"
    version: "{{ data_line | regex_search('VERSION=([^|]+)', '\\1') | first }}"
    config_path: "{{ data_line | regex_search('CONFIG=([^|]+)', '\\1') | first }}"
    dbpath: "{{ data_line | regex_search('DBPATH=([^|]+)', '\\1') | first }}"
    ports_raw: "{{ data_line | regex_search('PORTS=([^|]+)', '\\1') | first }}"
    logpath: "{{ data_line | regex_search('LOGPATH=([^|]+)', '\\1') | first }}"

    pids_array: "{{ pids_raw.split(',') | map('int') | list if pids_raw else [] }}"
    ports_array: "{{ ports_raw.split(',') | map('int') | list if ports_raw != 'none' else [] }}"

    json_instance:
      service_type: "DATABASE"
      service_name: "mongodb"
      service_version: "{{ version }}"
      port: "{{ ports_array[0] if ports_array | length > 0 else 0 }}"
      pid: "{{ pids_array[0] if pids_array | length > 0 else 0 }}"

      paths:
        binary_path: "{{ binary_path }}"
        config_path: "{{ config_path }}"
        data_path: "{{ dbpath }}"
        log_path: "{{ logpath }}"

      additional_details:
        all_ports: "{{ ports_array }}"
        all_pids: "{{ pids_array }}"

      status: "{{ 'RUNNING' if pids_array | length > 0 else 'STOPPED' }}"
  loop: "{{ mongodb_data_collection.results }}"
  when: item.stdout is defined



#################################################################
# Append MongoDB services to global discovered_services
#################################################################

- name: Append MongoDB services to discovered_services
  set_fact:
    discovered_services: "{{ discovered_services + (discovery_array | default([])) }}"




