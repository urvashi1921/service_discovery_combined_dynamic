# roles/linux/db/postgres - tasks

---
# ===================================================================
# PostgreSQL Discovery Playbook
# Optimized: Single ps snapshot, Linux-only, scalable to 10k hosts
# WEBHOOK ONLY - No File Saving
# ===================================================================

# - name: PostgreSQL Discovery - Optimized Single ps Snapshot
#   hosts: all
#   become: yes
#   gather_facts: yes

#   tasks:
#     # ===================================================================
#     # STEP 0: Take a Single Snapshot of All Running Processes
#     # ===================================================================

  - name: Capture full process list once
    shell: ps auxww
    register: ps_snapshot
    changed_when: false
    failed_when: false

  # ===================================================================
  # Detect network tool once
  # ===================================================================
  - name: Detect network tool
    shell: |
      if command -v ss >/dev/null 2>&1; then echo "ss"
      elif command -v netstat >/dev/null 2>&1; then echo "netstat"
      elif command -v lsof >/dev/null 2>&1; then echo "lsof"
      else echo "none"; fi
    register: network_tool
    changed_when: false
    failed_when: false

  # ===================================================================
  # STEP 1: Extract PostgreSQL Processes From Single Snapshot
  # ===================================================================
  - name: Extract PostgreSQL processes from snapshot
    shell: |
      echo "{{ ps_snapshot.stdout }}" | \
      grep -E '[p]ostgres|[p]ostmaster' | \
      awk '{print $2":"$11}' | sort -u
    register: running_postgres_processes
    changed_when: false
    failed_when: false

  # ===================================================================
  # STEP 2: Extract Unique Binary Paths
  # ===================================================================
  - name: Extract unique binaries from ps snapshot
    shell: |
      echo "{{ ps_snapshot.stdout }}" | \
      grep -E '[p]ostgres|[p]ostmaster' | \
      awk '{print $11}' | sort -u
    register: unique_binaries_raw
    changed_when: false
    failed_when: false

  - name: Validate binaries exist
    shell: |
      echo "{{ unique_binaries_raw.stdout }}" | tr ' ' '\n' | while read bin; do
        if [ -x "$bin" ]; then echo "$bin"; fi
      done
    register: unique_binaries
    changed_when: false
    failed_when: false

  - name: Set unique binaries fact
    set_fact:
      postgres_unique_binaries: "{{ unique_binaries.stdout_lines | default([]) }}"

  # ===================================================================
  # STEP 3: Collect Metadata for Each Binary
  # ===================================================================
  - name: Collect all data for each unique binary
    shell: |
      BINARY="{{ item }}"

      # Extract matching PIDs from single ps snapshot
      PIDS=$(echo "{{ ps_snapshot.stdout }}" | \
        grep -E '[p]ostgres|[p]ostmaster' | \
        awk -v bin="$BINARY" '$11 == bin {print $2}' | paste -sd, -)

      VERSION="unknown"
      if [ -x "$BINARY" ]; then
        VERSION=$($BINARY --version 2>/dev/null | grep -oP 'postgres \(PostgreSQL\) \K[0-9]+\.[0-9]+' | head -1)
      fi
      [ -z "$VERSION" ] && VERSION="unknown"

      DATADIR=""
      CONFIG_PATH=""
      if [ -n "$PIDS" ]; then
        FIRST_PID=$(echo $PIDS | cut -d, -f1)
        FULL_CMD=$(echo "{{ ps_snapshot.stdout }}" | grep " $FIRST_PID ")

        DATADIR=$(echo "$FULL_CMD" | grep -oP '\-D\s*\K[^ ]+')
        if [ -z "$DATADIR" ]; then
          DATADIR=$(ps eww -p $FIRST_PID | grep -oP 'PGDATA=\K[^ ]+')
        fi

        if [ -z "$DATADIR" ]; then
          for dir in /var/lib/pgsql/*/data /var/lib/postgresql/*/main /usr/local/pgsql/data; do
            if [ -d "$dir" ] && [ -f "$dir/PG_VERSION" ]; then
              DATADIR="$dir"
              break
            fi
          done
        fi

        if [ -n "$DATADIR" ] && [ -f "$DATADIR/postgresql.conf" ]; then
          CONFIG_PATH="$DATADIR/postgresql.conf"
        elif [ -n "$DATADIR" ] && [ -f "$DATADIR/postgresql.auto.conf" ]; then
          CONFIG_PATH="$DATADIR/postgresql.auto.conf"
        fi
      fi

      [ -z "$DATADIR" ] && DATADIR="/var/lib/pgsql/data"
      [ -z "$CONFIG_PATH" ] && CONFIG_PATH="not-found"

      PORTS=""
      case "{{ network_tool.stdout }}" in
        ss)
          for pid in $(echo $PIDS | tr ',' ' '); do
            PORTS="$PORTS $(ss -ltnp | grep "pid=$pid" | awk '{print $4}' | awk -F: '{print $NF}')"
          done
          ;;
        netstat)
          for pid in $(echo $PIDS | tr ',' ' '); do
            PORTS="$PORTS $(netstat -tulnp | grep "$pid/" | awk '{print $4}' | awk -F: '{print $NF}')"
          done
          ;;
        lsof)
          for pid in $(echo $PIDS | tr ',' ' '); do
            PORTS="$PORTS $(lsof -p $pid -i -P -n | awk '{print $9}' | awk -F: '{print $2}')"
          done
          ;;
      esac

      PORTS=$(echo $PORTS | tr ' ' '\n' | grep -E '^[0-9]+$' | sort -u | paste -sd, -)
      [ -z "$PORTS" ] && PORTS="none"

      LOGDIR=""
      if [ -n "$DATADIR" ] && [ -d "$DATADIR/log" ]; then
        LOGDIR="$DATADIR/log"
      elif [ -n "$DATADIR" ] && [ -d "$DATADIR/pg_log" ]; then
        LOGDIR="$DATADIR/pg_log"
      else
        LOGDIR="/var/log/postgresql"
      fi

      PG_VERSION_FILE=""
      if [ -f "$DATADIR/PG_VERSION" ]; then
        PG_VERSION_FILE=$(cat "$DATADIR/PG_VERSION")
      fi

      echo "BINARY=$BINARY|||PIDS=$PIDS|||VERSION=$VERSION|||CONFIG=$CONFIG_PATH|||DATADIR=$DATADIR|||PORTS=$PORTS|||LOGDIR=$LOGDIR|||BINDIR=$(dirname "$BINARY")|||PGVERSION=$PG_VERSION_FILE"
    args:
      executable: /bin/bash
    register: postgres_data_collection
    changed_when: false
    failed_when: false
    loop: "{{ postgres_unique_binaries }}"
    when: postgres_unique_binaries | length > 0
  
  - name: Initialize discovery array
    set_fact:
      discovery_array: []

  - name: Parse each instance
    set_fact:
      discovery_array: "{{ discovery_array + [json_instance] }}"
    vars:
      data_line: "{{ item.stdout }}"
      binary_path: "{{ data_line | regex_search('BINARY=([^|]+)', '\\1') | first }}"
      pids_raw: "{{ data_line | regex_search('PIDS=([^|]+)', '\\1') | first }}"
      version: "{{ data_line | regex_search('VERSION=([^|]+)', '\\1') | first }}"
      config_path: "{{ data_line | regex_search('CONFIG=([^|]+)', '\\1') | first }}"
      datadir: "{{ data_line | regex_search('DATADIR=([^|]+)', '\\1') | first }}"
      ports_raw: "{{ data_line | regex_search('PORTS=([^|]+)', '\\1') | first }}"
      logdir: "{{ data_line | regex_search('LOGDIR=([^|]+)', '\\1') | first }}"

      pids_array: "{{ pids_raw.split(',') | map('int') | list if pids_raw else [] }}"
      ports_array: "{{ ports_raw.split(',') | map('int') | list if ports_raw != 'none' else [] }}"

      json_instance:
        service_type: "DATABASE"
        service_name: "postgresql"
        service_version: "{{ version }}"
        port: "{{ ports_array[0] if ports_array | length > 0 else 5432 }}"
        pid: "{{ pids_array[0] if pids_array | length > 0 else 0 }}"

        paths:
          binary_path: "{{ binary_path }}"
          config_path: "{{ config_path }}"
          data_path: "{{ datadir }}"
          log_path: "{{ logdir }}"

        additional_details:
          all_ports: "{{ ports_array }}"
          all_pids: "{{ pids_array }}"

        status: "{{ 'RUNNING' if pids_array | length > 0 else 'STOPPED' }}"
    loop: "{{ postgres_data_collection.results }}"
    when: item.stdout is defined


  #################################################################
  # Append PostgreSQL services to global discovered_services
  #################################################################

  - name: Append PostgreSQL services to discovered_services
    set_fact:
      discovered_services: "{{ discovered_services + (discovery_array | default([])) }}"
