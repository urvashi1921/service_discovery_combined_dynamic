---
#################################################################
# MySQL Discovery Role Tasks (Windows)
#################################################################

# ========================================
# STEP 0: Snapshot all MySQL processes
# ========================================
- name: Debug - Show all MySQL-related processes
  win_shell: |
    Write-Output "=== All MySQL-related processes ==="
    Get-CimInstance Win32_Process -Filter "Name LIKE '%mysql%'" |
    Select-Object ProcessId, Name, CommandLine, ExecutablePath |
    Format-List
  register: mysql_debug
  changed_when: false
  failed_when: false

- name: Show debug output
  debug:
    msg: "{{ mysql_debug.stdout }}"

# ========================================
# STEP 1: Extract unique binary paths
# ========================================
- name: Extract unique binaries from running processes
  win_shell: |
    Get-CimInstance Win32_Process -Filter "Name='mysqld.exe' OR Name='mysqld-nt.exe' OR Name='mariadbd.exe'" |
    Select-Object -ExpandProperty ExecutablePath |
    Where-Object { $_ -ne $null -and $_ -ne '' } |
    Sort-Object -Unique
  register: unique_binaries
  changed_when: false
  failed_when: false

- name: Set unique binaries fact
  set_fact:
    mysql_unique_binaries: "{{ unique_binaries.stdout_lines | default([]) | select('search', '.exe') | list }}"

- name: Debug - Show captured binaries
  debug:
    msg: "MySQL binaries found: {{ mysql_unique_binaries }}"

# ========================================
# FALLBACK: Discover binary path from Windows Service
# ========================================
- name: Find MySQL services and extract binary path
  win_shell: |
    $svc = Get-CimInstance Win32_Service -Filter "Name='MySQL80' OR Name='MySQL57' OR Name='MySQL56' OR Name LIKE 'MySQL%' OR Name LIKE 'MariaDB%'"
    if (-not $svc) {
      Write-Output ""
      exit 0
    }
    foreach ($s in $svc) {
      $path = $s.PathName
      # Strip surrounding quotes if present
      $path = $path -replace '^"', '' -replace '".*$', ''
      # Extract just the .exe path (remove any trailing args)
      if ($path -match '^(.+\.exe)') {
        Write-Output $matches[1].Trim()
      }
    }
  register: service_binary_discovery
  changed_when: false
  failed_when: false
  when: mysql_unique_binaries | length == 0

- name: Debug - Service binary discovery result
  debug:
    msg: "Service binary discovery: {{ service_binary_discovery.stdout_lines | default([]) }}"
  when: mysql_unique_binaries | length == 0

- name: Add service binaries to list if no processes found
  set_fact:
    mysql_unique_binaries: "{{ service_binary_discovery.stdout_lines | select('search', '.exe') | list }}"
  when:
    - mysql_unique_binaries | length == 0
    - service_binary_discovery.stdout_lines is defined
    - service_binary_discovery.stdout_lines | select('search', '.exe') | list | length > 0

- name: Debug - Final binaries list
  debug:
    msg: "Final MySQL binaries: {{ mysql_unique_binaries }}"

# ========================================
# STEP 2: Write PowerShell collector script to disk
# Using win_copy avoids ALL Jinja2/YAML quote-stripping issues.
# ========================================
- name: Write MySQL data collector script to disk
  win_copy:
    dest: C:\Windows\Temp\mysql_collect.ps1
    content: |
      param([string]$BinaryPath)
      $ErrorActionPreference = 'SilentlyContinue'

      $BINARY = $BinaryPath.Trim()
      if (-not $BINARY -or $BINARY -eq '') {
        Write-Output "BINARY=NONE^^^PIDS=none^^^VERSION=unknown^^^CONFIG=not-found^^^DATADIR=C:\ProgramData\MySQL\data^^^PORTS=3306^^^LOGPATH=not-found^^^BINDIR=^^^SERVICE=not-found"
        exit 0
      }

      # ---- PIDs ----
      # Escape backslashes and single-quotes for WMI CQL filter
      $escapedForWMI = $BINARY -replace "\\", "\\\\" -replace "'", "\\'"
      $processes = Get-CimInstance Win32_Process -Filter "ExecutablePath = '$escapedForWMI'"
      $PIDs = @($processes | ForEach-Object { $_.ProcessId })
      $PIDS_STRING = if ($PIDs.Count -gt 0) { ($PIDs -join ',') } else { "none" }

      # ---- VERSION ----
      $VERSION = "unknown"
      if (Test-Path $BINARY) {
        try {
          $fi = Get-Item $BINARY -ErrorAction Stop
          $v  = $fi.VersionInfo.FileVersion
          if (-not $v -or $v -eq '') { $v = $fi.VersionInfo.ProductVersion }
          if ($v -and $v -ne '') { $VERSION = $v.Trim() }
        } catch {}
      }
      # Fallback: parse version from --version output
      if ($VERSION -eq "unknown" -and (Test-Path $BINARY)) {
        try {
          $vOut = & "$BINARY" --version 2>&1 | Out-String
          if ($vOut -match '(\d+\.\d+\.\d+)') { $VERSION = $matches[1] }
        } catch {}
      }

      # ---- CONFIG / DATADIR / LOGPATH from process command line ----
      $CONFIG_PATH = "not-found"
      $DATADIR     = "not-found"
      $LOGPATH     = "not-found"

      if ($PIDs.Count -gt 0) {
        $cmdLine = $processes[0].CommandLine
        if ($cmdLine) {
          if    ($cmdLine -match '--defaults-file[= ]+"([^"]+)"')  { $c = $matches[1]; if (Test-Path $c) { $CONFIG_PATH = $c } }
          elseif($cmdLine -match "--defaults-file[= ]+'([^']+)'")  { $c = $matches[1]; if (Test-Path $c) { $CONFIG_PATH = $c } }
          elseif($cmdLine -match '--defaults-file[= ]+(\S+)')      { $c = $matches[1]; if (Test-Path $c) { $CONFIG_PATH = $c } }

          if    ($cmdLine -match '--datadir[= ]+"([^"]+)"')        { $c = $matches[1]; if (Test-Path $c) { $DATADIR = $c } }
          elseif($cmdLine -match "--datadir[= ]+'([^']+)'")        { $c = $matches[1]; if (Test-Path $c) { $DATADIR = $c } }
          elseif($cmdLine -match '--datadir[= ]+(\S+)')            { $c = $matches[1]; if (Test-Path $c) { $DATADIR = $c } }

          if    ($cmdLine -match '--log-error[= ]+"([^"]+)"')      { $LOGPATH = $matches[1] }
          elseif($cmdLine -match "--log-error[= ]+'([^']+)'")      { $LOGPATH = $matches[1] }
          elseif($cmdLine -match '--log-error[= ]+(\S+)')          { $LOGPATH = $matches[1] }
        }
      }

      # ---- CONFIG fallback: check well-known paths ----
      if ($CONFIG_PATH -eq "not-found") {
        $BIN_DIR_TMP = Split-Path -Parent $BINARY
        $INSTALL_DIR = Split-Path -Parent $BIN_DIR_TMP
        $candidates = @(
          (Join-Path $INSTALL_DIR "my.ini"),
          (Join-Path $INSTALL_DIR "my.cnf"),
          'C:\Program Files\MySQL\MySQL Server 8.0\my.ini',
          'C:\Program Files\MySQL\MySQL Server 5.7\my.ini',
          'C:\Program Files (x86)\MySQL\MySQL Server 8.0\my.ini',
          'C:\MySQL\my.ini',
          "$env:WINDIR\my.ini",
          "$env:WINDIR\my.cnf",
          'C:\ProgramData\MySQL\MySQL Server 8.0\my.ini'
        )
        foreach ($cfg in $candidates) {
          if (Test-Path $cfg) { $CONFIG_PATH = $cfg; break }
        }
      }

      # ---- DATADIR fallback: parse from my.ini ----
      if ($DATADIR -eq "not-found" -and $CONFIG_PATH -ne "not-found") {
        $iniContent = Get-Content $CONFIG_PATH -ErrorAction SilentlyContinue
        foreach ($line in $iniContent) {
          if ($line -match '^\s*datadir\s*=\s*(.+)') {
            $d = $matches[1].Trim().Trim('"').Trim("'")
            if (Test-Path $d) { $DATADIR = $d; break }
          }
        }
      }
      if ($DATADIR -eq "not-found") {
        $DATADIR = "C:\ProgramData\MySQL\MySQL Server 8.0\data"
      }

      # ---- PORTS ----
      $PORTS = @()
      foreach ($p in $PIDs) {
        $conns = Get-NetTCPConnection -OwningProcess $p -State Listen -ErrorAction SilentlyContinue
        foreach ($c in $conns) { if ($c.LocalPort) { $PORTS += $c.LocalPort } }
      }
      if ($PORTS.Count -eq 0 -and $PIDs.Count -gt 0) {
        $nsLines = netstat -ano 2>$null
        foreach ($line in $nsLines) {
          foreach ($p in $PIDs) {
            if ($line -match "TCP\s+[^\s]+:(\d+)\s+[^\s]+\s+LISTENING\s+${p}\s*$") {
              $PORTS += [int]$matches[1]
            }
          }
        }
      }
      # Also try reading port from my.ini
      if ($PORTS.Count -eq 0 -and $CONFIG_PATH -ne "not-found") {
        $iniContent = Get-Content $CONFIG_PATH -ErrorAction SilentlyContinue
        foreach ($line in $iniContent) {
          if ($line -match '^\s*port\s*=\s*(\d+)') {
            $PORTS += [int]$matches[1]; break
          }
        }
      }
      $PORTS = @($PORTS | Select-Object -Unique | Sort-Object)
      $PORTS_STRING = if ($PORTS.Count -gt 0) { ($PORTS -join ',') } else { "3306" }

      $BIN_DIR = Split-Path -Parent $BINARY

      # ---- SERVICE NAME ----
      # Match MySQL/MariaDB services and verify PathName contains mysqld/mariadbd
      $SERVICE_NAME = "not-found"
      $allSvcs = Get-CimInstance Win32_Service -Filter "Name LIKE 'MySQL%' OR Name LIKE 'MariaDB%'" -ErrorAction SilentlyContinue
      foreach ($s in $allSvcs) {
        $sPath = $s.PathName -replace '"', ''
        if ($sPath -like "*mysqld*" -or $sPath -like "*mariadbd*") {
          $SERVICE_NAME = $s.Name
          break
        }
      }

      Write-Output "BINARY=$BINARY^^^PIDS=$PIDS_STRING^^^VERSION=$VERSION^^^CONFIG=$CONFIG_PATH^^^DATADIR=$DATADIR^^^PORTS=$PORTS_STRING^^^LOGPATH=$LOGPATH^^^BINDIR=$BIN_DIR^^^SERVICE=$SERVICE_NAME"
  changed_when: false

# ========================================
# STEP 3: Execute the script for each binary
# ========================================
- name: Debug - Show binary being processed
  debug:
    msg: "Processing MySQL binary: {{ item }}"
  loop: "{{ mysql_unique_binaries }}"
  when: mysql_unique_binaries | length > 0

- name: Collect all data for each unique binary
  win_shell: "& 'C:\\Windows\\Temp\\mysql_collect.ps1' -BinaryPath '{{ item }}'"
  args:
    executable: powershell.exe
  register: mysql_data_collection
  changed_when: false
  failed_when: false
  loop: "{{ mysql_unique_binaries }}"
  when: mysql_unique_binaries | length > 0

- name: Debug - Show data collection results
  debug:
    msg: "stdout: [{{ item.stdout | default('EMPTY') }}] | rc: {{ item.rc | default('?') }} | stderr: {{ item.stderr | default('NONE') }}"
  loop: "{{ mysql_data_collection.results | default([]) }}"
  when: mysql_unique_binaries | length > 0

# ========================================
# STEP 4: Clean up temp script
# ========================================
- name: Remove temp collector script
  win_file:
    path: C:\Windows\Temp\mysql_collect.ps1
    state: absent
  changed_when: false
  failed_when: false

# ========================================
# STEP 5: Parse into JSON
# ========================================
- name: Initialize discovery array
  set_fact:
    discovery_array: []

- name: Parse each instance
  set_fact:
    discovery_array: "{{ discovery_array + [json_instance] }}"
  vars:
    data_line: "{{ item.stdout_lines | select('search', '^BINARY=') | list | first | default('') }}"

    binary_path:  "{{ (data_line | regex_search('BINARY=([^^]+)', '\\1') or [''])[0] | trim }}"
    pids_raw:     "{{ (data_line | regex_search('PIDS=([^^]+)', '\\1') or [''])[0] | trim }}"
    version:      "{{ (data_line | regex_search('VERSION=([^^]+)', '\\1') or ['unknown'])[0] | trim }}"
    config_path:  "{{ (data_line | regex_search('CONFIG=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    datadir:      "{{ (data_line | regex_search('DATADIR=([^^]+)', '\\1') or ['C:\\ProgramData\\MySQL\\data'])[0] | trim }}"
    ports_raw:    "{{ (data_line | regex_search('PORTS=([^^]+)', '\\1') or ['3306'])[0] | trim }}"
    logpath:      "{{ (data_line | regex_search('LOGPATH=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    service_name: "{{ (data_line | regex_search('SERVICE=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"

    pids_array:  "{{ pids_raw.split(',') | map('int') | list if pids_raw not in ['', 'none'] else [] }}"
    ports_array: "{{ ports_raw.split(',') | map('int') | list if ports_raw not in ['', 'none'] else [3306] }}"

    json_instance:
      service_type: "DATABASE"
      service_name: "mysql"
      service_version: "{{ version }}"
      port: "{{ ports_array[0] if ports_array | length > 0 else 3306 }}"
      pid:  "{{ pids_array[0] if pids_array | length > 0 else 0 }}"
      paths:
        binary_path: "{{ binary_path }}"
        config_path: "{{ config_path if config_path != 'not-found' else None }}"
        data_path:   "{{ datadir }}"
        log_path:    "{{ logpath if logpath != 'not-found' else None }}"
      additional_details:
        all_ports:    "{{ ports_array }}"
        all_pids:     "{{ pids_array }}"
        service_name: "{{ service_name if service_name != 'not-found' else None }}"
      status: "{{ 'RUNNING' if pids_array | length > 0 else 'STOPPED' }}"
  loop: "{{ mysql_data_collection.results | default([]) }}"
  when:
    - item.stdout is defined
    - item.stdout | trim != ''
    - item.stdout_lines | select('search', '^BINARY=') | list | length > 0

#################################################################
# Append MySQL services to global discovered_services
#################################################################
- name: Append MySQL services to discovered_services
  set_fact:
    discovered_services: "{{ discovered_services + (discovery_array | default([])) }}"