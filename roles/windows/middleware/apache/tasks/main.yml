---
#################################################################
# Apache HTTP Server Discovery Role Tasks (Windows)
#################################################################

# ========================================
# STEP 0: Snapshot all Apache processes
# ========================================
- name: Debug - Show all Apache-related processes
  win_shell: |
    Write-Output "=== All Apache-related processes ==="
    Get-CimInstance Win32_Process -Filter "Name LIKE '%httpd%' OR Name LIKE '%Apache%' OR Name LIKE '%httpd.exe%'" |
    Select-Object ProcessId, Name, CommandLine, ExecutablePath |
    Format-List
  register: apache_debug
  changed_when: false
  failed_when: false

- name: Show debug output
  debug:
    msg: "{{ apache_debug.stdout }}"
  when: apache_debug.stdout is defined

# ========================================
# STEP 1: Extract unique Apache binaries from running processes
# ========================================
- name: Extract unique Apache binaries from running processes
  win_shell: |
    $processes = Get-CimInstance Win32_Process -Filter "Name='httpd.exe'" -ErrorAction SilentlyContinue

    if (-not $processes) {
      $processes = Get-CimInstance Win32_Process -Filter "Name LIKE '%httpd%' OR Name LIKE '%Apache%'" -ErrorAction SilentlyContinue |
        Where-Object { $_.CommandLine -like '*httpd*' -or $_.CommandLine -like '*apache*' }
    }

    $uniqueBinaries = @()
    foreach ($proc in $processes) {
      $binPath = $proc.ExecutablePath
      if ($binPath -and $binPath -ne '' -and $uniqueBinaries -notcontains $binPath) {
        $uniqueBinaries += $binPath
      }
    }

    $uniqueBinaries | ForEach-Object { Write-Output $_ }
  register: unique_binaries
  changed_when: false
  failed_when: false

- name: Set unique binaries fact
  set_fact:
    apache_unique_binaries: "{{ unique_binaries.stdout_lines | default([]) | select('search', '.exe') | list }}"

- name: Debug - Show captured binaries
  debug:
    msg: "Apache binaries found: {{ apache_unique_binaries }}"

# ========================================
# FALLBACK: Discover Apache from Windows Service
# ========================================
- name: Find Apache services and extract binary paths
  win_shell: |
    $filterStr = 'Name LIKE "%apache%" OR Name LIKE "%httpd%" OR DisplayName LIKE "%Apache%" OR DisplayName LIKE "%HTTP Server%"'
    $svc = Get-CimInstance Win32_Service -Filter $filterStr -ErrorAction SilentlyContinue
    if (-not $svc) {
      Write-Output ""
      exit 0
    }

    $uniquePaths = @()
    foreach ($s in $svc) {
      $path = $s.PathName
      $path = $path -replace '^"', '' -replace '".*$', ''
      $path = $path -replace '\s.*$', ''

      if ($path -like '*httpd.exe' -and $uniquePaths -notcontains $path) {
        $uniquePaths += $path
        Write-Output $path
      }
    }
  register: service_binary_discovery
  changed_when: false
  failed_when: false
  when: apache_unique_binaries | length == 0

- name: Debug - Service binary discovery result
  debug:
    msg: "Service binary discovery: {{ service_binary_discovery.stdout_lines | default([]) }}"
  when: apache_unique_binaries | length == 0

- name: Add service binaries to list if no processes found
  set_fact:
    apache_unique_binaries: "{{ service_binary_discovery.stdout_lines | select('search', '.exe') | list }}"
  when:
    - apache_unique_binaries | length == 0
    - service_binary_discovery.stdout_lines is defined
    - service_binary_discovery.stdout_lines | select('search', '.exe') | list | length > 0

- name: Debug - Final binaries list
  debug:
    msg: "Final Apache binaries: {{ apache_unique_binaries }}"

# ========================================
# STEP 2: Write PowerShell collector script to disk
# ========================================
- name: Write Apache data collector script to disk
  win_copy:
    dest: C:\Windows\Temp\apache_collect.ps1
    content: |
      param([string]$BinaryPath)

      $ErrorActionPreference = 'SilentlyContinue'

      $BINARY = $BinaryPath.Trim()
      if (-not $BINARY -or $BINARY -eq '') {
        Write-Output "BINARY=none^^^PIDS=none^^^VERSION=unknown^^^CONFIG=not-found^^^SERVER_ROOT=not-found^^^PORTS=none^^^CONFIG_PORTS=none^^^DOC_ROOT=not-found^^^BINDIR=^^^SERVICE=not-found"
        exit 0
      }

      # ---- PIDs ----
      $escapedForWMI = $BINARY -replace "\\", "\\\\" -replace "'", "\\'"
      $processes = Get-CimInstance Win32_Process -Filter "ExecutablePath = '$escapedForWMI'" -ErrorAction SilentlyContinue
      $PIDs = @($processes | ForEach-Object { $_.ProcessId })
      $PIDS_STRING = if ($PIDs.Count -gt 0) { ($PIDs -join ',') } else { "none" }

      # ---- VERSION from binary ----
      $VERSION = "unknown"
      if (Test-Path $BINARY) {
        try {
          $versionOutput = & "$BINARY" -v 2>&1 | Out-String
          if ($versionOutput -match 'Server version:\s*/?\s*(\d+\.\d+\.\d+)') {
            $VERSION = $matches[1]
          } elseif ($versionOutput -match '/(\d+\.\d+\.\d+)') {
            $VERSION = $matches[1]
          }
        } catch {
          try {
            $fi = Get-Item $BINARY
            $v = $fi.VersionInfo.FileVersion
            if ($v -and $v -ne '' -and $v -ne '0.0.0.0') { $VERSION = $v }
          } catch {}
        }
      }

      # ---- BIN DIRECTORY ----
      $BIN_DIR = Split-Path -Parent $BINARY

      # ---- SERVER ROOT ----
      $SERVER_ROOT = Split-Path -Parent $BIN_DIR

      # ---- CONFIG PATH ----
      $CONFIG_PATH = "not-found"
      $configCandidates = @(
        (Join-Path $SERVER_ROOT "conf\httpd.conf"),
        (Join-Path $SERVER_ROOT "conf\apache2.conf"),
        (Join-Path $SERVER_ROOT "conf\extra\httpd-ssl.conf"),
        "C:\Apache24\conf\httpd.conf",
        "C:\Apache2\conf\httpd.conf",
        "C:\Apache\conf\httpd.conf",
        "C:\xampp\apache\conf\httpd.conf",
        "C:\wamp\bin\apache\apache2.4.23\conf\httpd.conf"
      )

      foreach ($cfg in $configCandidates) {
        if (Test-Path $cfg) {
          $CONFIG_PATH = $cfg
          break
        }
      }

      if ($CONFIG_PATH -eq "not-found") {
        $confDir = Join-Path $SERVER_ROOT "conf"
        if (Test-Path $confDir) {
          $confFiles = Get-ChildItem $confDir -Filter "*.conf" -ErrorAction SilentlyContinue
          if ($confFiles) {
            $mainConf = $confFiles | Where-Object { $_.Name -like 'httpd.conf' -or $_.Name -like 'apache*.conf' } |
              Select-Object -First 1
            if ($mainConf) {
              $CONFIG_PATH = $mainConf.FullName
            }
          }
        }
      }

      # ---- CONFIG PORTS from httpd.conf ----
      $CONFIG_PORTS = @()
      if ($CONFIG_PATH -ne "not-found") {
        $confContent = Get-Content $CONFIG_PATH -ErrorAction SilentlyContinue
        foreach ($line in $confContent) {
          if ($line -match '^\s*Listen\s+([0-9]+)') {
            $CONFIG_PORTS += [int]$matches[1]
          } elseif ($line -match '^\s*Listen\s+.*?:([0-9]+)') {
            $CONFIG_PORTS += [int]$matches[1]
          } elseif ($line -match '^\s*Listen\s+\[?\]:([0-9]+)') {
            $CONFIG_PORTS += [int]$matches[1]
          }
        }
      }

      if ($CONFIG_PATH -ne "not-found") {
        $confContent = Get-Content $CONFIG_PATH -ErrorAction SilentlyContinue
        foreach ($line in $confContent) {
          if ($line -match '<VirtualHost\s+.*?:([0-9]+)>') {
            $port = [int]$matches[1]
            if ($port -notin $CONFIG_PORTS) { $CONFIG_PORTS += $port }
          }
          if ($line -match '<VirtualHost\s+\[?::?\]?:?([0-9]+)>') {
            $port = [int]$matches[1]
            if ($port -notin $CONFIG_PORTS) { $CONFIG_PORTS += $port }
          }
        }
      }

      $CONFIG_PORTS = @($CONFIG_PORTS | Select-Object -Unique | Sort-Object)
      $CONFIG_PORTS_STRING = if ($CONFIG_PORTS.Count -gt 0) { ($CONFIG_PORTS -join ',') } else { "none" }

      # ---- RUNTIME PORTS ----
      $PORTS = @()
      foreach ($p in $PIDs) {
        $conns = Get-NetTCPConnection -OwningProcess $p -State Listen -ErrorAction SilentlyContinue
        foreach ($c in $conns) {
          if ($c.LocalPort) { $PORTS += $c.LocalPort }
        }
      }
      $PORTS = @($PORTS | Select-Object -Unique | Sort-Object)
      $PORTS_STRING = if ($PORTS.Count -gt 0) { ($PORTS -join ',') } else { "none" }

      # ---- DOCUMENT ROOT ----
      $DOC_ROOT = "not-found"
      if ($CONFIG_PATH -ne "not-found") {
        $confContent = Get-Content $CONFIG_PATH -ErrorAction SilentlyContinue
        foreach ($line in $confContent) {
          if ($line -match '^\s*DocumentRoot\s+"?([^"\s]+)"?') {
            $DOC_ROOT = $matches[1]
            break
          }
        }
      }

      if ($DOC_ROOT -eq "not-found") {
        $docRootCandidates = @(
          (Join-Path $SERVER_ROOT "htdocs"),
          "C:\Apache24\htdocs",
          "C:\Apache2\htdocs",
          "C:\Apache\htdocs",
          "C:\xampp\htdocs",
          "C:\wamp\www"
        )
        foreach ($dr in $docRootCandidates) {
          if (Test-Path $dr) {
            $DOC_ROOT = $dr
            break
          }
        }
      }

      # ---- SERVICE NAME ----
      $SERVICE_NAME = "not-found"
      $svcFilter = 'Name LIKE "%apache%" OR Name LIKE "%httpd%" OR DisplayName LIKE "%Apache%"'
      $allSvcs = Get-CimInstance Win32_Service -Filter $svcFilter -ErrorAction SilentlyContinue
      foreach ($s in $allSvcs) {
        $sPath = $s.PathName -replace '"', '' -replace '\s.*$', ''
        if ($sPath -eq $BINARY) {
          $SERVICE_NAME = $s.Name
          break
        }
      }

      # ---- MODULES ----
      $MODULES = ""
      if ($CONFIG_PATH -ne "not-found") {
        $confContent = Get-Content $CONFIG_PATH -ErrorAction SilentlyContinue
        $loadedModules = @()
        foreach ($line in $confContent) {
          if ($line -match '^\s*LoadModule\s+(\w+)\s+') {
            $loadedModules += $matches[1]
          }
        }
        if ($loadedModules.Count -gt 0) {
          $MODULES = ($loadedModules | Select-Object -First 10) -join ','
        }
      }

      # ---- HTTPD ROOT ----
      $HTTPD_ROOT = $SERVER_ROOT

      Write-Output "BINARY=$BINARY^^^PIDS=$PIDS_STRING^^^VERSION=$VERSION^^^CONFIG=$CONFIG_PATH^^^SERVER_ROOT=$SERVER_ROOT^^^PORTS=$PORTS_STRING^^^CONFIG_PORTS=$CONFIG_PORTS_STRING^^^DOC_ROOT=$DOC_ROOT^^^BINDIR=$BIN_DIR^^^SERVICE=$SERVICE_NAME^^^HTTPD_ROOT=$HTTPD_ROOT^^^MODULES=$MODULES"
  changed_when: false

# ========================================
# STEP 3: Execute the script for each binary
# ========================================
- name: Debug - Show binary being processed
  debug:
    msg: "Processing Apache binary: {{ item }}"
  loop: "{{ apache_unique_binaries }}"
  when: apache_unique_binaries | length > 0

- name: Collect all data for each unique Apache binary
  win_shell: "& 'C:\\Windows\\Temp\\apache_collect.ps1' -BinaryPath '{{ item }}'"
  args:
    executable: powershell.exe
  register: apache_data_collection
  changed_when: false
  failed_when: false
  loop: "{{ apache_unique_binaries }}"
  when: apache_unique_binaries | length > 0

- name: Debug - Show data collection results
  debug:
    msg: "stdout: [{{ item.stdout | default('EMPTY') }}] | rc: {{ item.rc | default('?') }}"
  loop: "{{ apache_data_collection.results | default([]) }}"
  when: apache_unique_binaries | length > 0

# ========================================
# STEP 4: Clean up temp script
# ========================================
- name: Remove temp collector script
  win_file:
    path: C:\Windows\Temp\apache_collect.ps1
    state: absent
  changed_when: false
  failed_when: false

# ========================================
# STEP 5: Parse into JSON
# ========================================
- name: Initialize Apache discovery array
  set_fact:
    discovery_array: []

- name: Parse each instance
  set_fact:
    discovery_array: "{{ discovery_array + [json_instance] }}"
  vars:
    data_line: "{{ item.stdout_lines | select('search', '^BINARY=') | list | first | default('') }}"

    binary_path:      "{{ (data_line | regex_search('BINARY=([^^]+)', '\\1') or [''])[0] | trim }}"
    pids_raw:         "{{ (data_line | regex_search('PIDS=([^^]+)', '\\1') or [''])[0] | trim }}"
    version:          "{{ (data_line | regex_search('VERSION=([^^]+)', '\\1') or ['unknown'])[0] | trim }}"
    config_path:      "{{ (data_line | regex_search('CONFIG=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    server_root:      "{{ (data_line | regex_search('SERVER_ROOT=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    ports_raw:        "{{ (data_line | regex_search('PORTS=([^^]+)', '\\1') or ['none'])[0] | trim }}"
    config_ports_raw: "{{ (data_line | regex_search('CONFIG_PORTS=([^^]+)', '\\1') or ['none'])[0] | trim }}"
    doc_root:         "{{ (data_line | regex_search('DOC_ROOT=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    bin_dir:          "{{ (data_line | regex_search('BINDIR=([^^]+)', '\\1') or [''])[0] | trim }}"
    service_name:     "{{ (data_line | regex_search('SERVICE=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    httpd_root:       "{{ (data_line | regex_search('HTTPD_ROOT=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    modules:          "{{ (data_line | regex_search('MODULES=([^^]+)', '\\1') or [''])[0] | trim }}"

    pids_array:         "{{ pids_raw.split(',') | map('int', default=0) | list if pids_raw not in ['', 'none'] else [] }}"
    ports_array:        "{{ ports_raw.split(',') | map('int', default=0) | list if ports_raw not in ['', 'none'] else [] }}"
    config_ports_array: "{{ config_ports_raw.split(',') | map('int', default=0) | list if config_ports_raw not in ['', 'none'] else [] }}"

    json_instance:
      service_type: "MIDDLEWARE"
      service_name: "apache"
      service_version: "{{ version }}"
      port: "{{ ports_array[0] if ports_array | length > 0 else None }}"
      pid:  "{{ pids_array[0] if pids_array | length > 0 else 0 }}"
      paths:
        binary_path: "{{ binary_path }}"
        config_path: "{{ config_path if config_path != 'not-found' else None }}"
        data_path:   "{{ doc_root if doc_root != 'not-found' else None }}"
      additional_details:
        all_ports:        "{{ ports_array }}"
        all_pids:         "{{ pids_array }}"
        server_root:      "{{ server_root if server_root != 'not-found' else None }}"
        httpd_root:       "{{ httpd_root if httpd_root != 'not-found' else None }}"
        configured_ports: "{{ config_ports_array }}"
        windows_service:  "{{ service_name if service_name != 'not-found' else None }}"
        loaded_modules:   "{{ modules if modules != '' else None }}"
      status: "{{ 'RUNNING' if pids_array | length > 0 else 'STOPPED' }}"
  loop: "{{ apache_data_collection.results | default([]) }}"
  when:
    - item.stdout is defined
    - item.stdout | trim != ''
    - item.stdout_lines | select('search', '^BINARY=') | list | length > 0

#################################################################
# Append Apache services to global discovered_services
#################################################################
- name: Append Apache services to discovered_services
  set_fact:
    discovered_services: "{{ discovered_services + (discovery_array | default([])) }}"

- name: Display discovery summary
  debug:
    msg: "Apache Discovery: {{ discovery_array | length }} instance(s) found on {{ inventory_hostname }}"