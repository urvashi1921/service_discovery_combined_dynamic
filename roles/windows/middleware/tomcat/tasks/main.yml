---
#################################################################
# Tomcat Discovery Role Tasks (Windows)
#################################################################

# ========================================
# STEP 0: Snapshot all Tomcat processes
# ========================================
- name: Debug - Show all Tomcat-related processes
  win_shell: |
    Write-Output "=== All Tomcat-related processes ==="
    Get-CimInstance Win32_Process -Filter "Name LIKE '%java%'" |
    Where-Object { $_.CommandLine -like '*Bootstrap*' -and $_.CommandLine -like '*catalina*' } |
    Select-Object ProcessId, Name, CommandLine, ExecutablePath |
    Format-List
  register: tomcat_debug
  changed_when: false
  failed_when: false

- name: Show debug output
  debug:
    msg: "{{ tomcat_debug.stdout }}"
  when: tomcat_debug.stdout is defined

# ========================================
# STEP 1: Extract unique Tomcat instances from running processes
# ========================================
- name: Extract unique Tomcat instances from running processes
  win_shell: |
    $processes = Get-CimInstance Win32_Process -Filter "Name LIKE '%java%'" |
      Where-Object { $_.CommandLine -like '*Bootstrap*' -and $_.CommandLine -like '*catalina*' }

    $uniqueInstances = @()
    foreach ($proc in $processes) {
      $cmdLine = $proc.CommandLine

      # Extract CATALINA_HOME
      $catalinaHome = ""
      if ($cmdLine -match '-Dcatalina\.home=([^\s"]+)') {
        $catalinaHome = $matches[1]
      } elseif ($cmdLine -match '-Dcatalina\.home="([^"]+)"') {
        $catalinaHome = $matches[1]
      }

      # Extract CATALINA_BASE
      $catalinaBase = ""
      if ($cmdLine -match '-Dcatalina\.base=([^\s"]+)') {
        $catalinaBase = $matches[1]
      } elseif ($cmdLine -match '-Dcatalina\.base="([^"]+)"') {
        $catalinaBase = $matches[1]
      }

      # If CATALINA_BASE not set, use CATALINA_HOME
      if ([string]::IsNullOrEmpty($catalinaBase)) {
        $catalinaBase = $catalinaHome
      }

      # Create unique identifier
      $instanceId = "$catalinaHome|$catalinaBase"
      if ($uniqueInstances -notcontains $instanceId -and -not [string]::IsNullOrEmpty($catalinaHome)) {
        $uniqueInstances += $instanceId
      }
    }

    $uniqueInstances | ForEach-Object { Write-Output $_ }
  register: unique_instances
  changed_when: false
  failed_when: false

- name: Set unique instances fact
  set_fact:
    tomcat_unique_instances: "{{ unique_instances.stdout_lines | default([]) | select('search', '.+') | list }}"

- name: Debug - Show captured instances
  debug:
    msg: "Tomcat instances found: {{ tomcat_unique_instances }}"

# ========================================
# FALLBACK: Discover Tomcat from Windows Service
# ========================================
- name: Find Tomcat services and extract installation paths
  win_shell: |
    $svc = Get-CimInstance Win32_Service -Filter "Name LIKE '%Tomcat%' OR DisplayName LIKE '%Tomcat%' OR Name LIKE '%Apache Tomcat%'"
    if (-not $svc) {
      Write-Output ""
      exit 0
    }

    $uniquePaths = @()
    foreach ($s in $svc) {
      $path = $s.PathName
      # Strip surrounding quotes
      $path = $path -replace '^"', '' -replace '".*$', ''

      # Try to extract CATALINA_HOME from the service path
      # Usually looks like: C:\Tomcat\bin\Tomcat9.exe //RS//Tomcat9
      if ($path -match '^(.+\\bin\\[^\\]+\.exe)') {
        $binPath = $matches[1]
        $catalinaHome = Split-Path -Parent (Split-Path -Parent $binPath)
        $instanceId = "$catalinaHome|$catalinaHome"
        if ($uniquePaths -notcontains $instanceId) {
          $uniquePaths += $instanceId
          Write-Output $instanceId
        }
      }
    }
  register: service_discovery
  changed_when: false
  failed_when: false
  when: tomcat_unique_instances | length == 0

- name: Debug - Service discovery result
  debug:
    msg: "Service discovery: {{ service_discovery.stdout_lines | default([]) }}"
  when: tomcat_unique_instances | length == 0

- name: Add service instances to list if no processes found
  set_fact:
    tomcat_unique_instances: "{{ service_discovery.stdout_lines | select('search', '.+') | list }}"
  when:
    - tomcat_unique_instances | length == 0
    - service_discovery.stdout_lines is defined
    - service_discovery.stdout_lines | select('search', '.+') | list | length > 0

- name: Debug - Final instances list
  debug:
    msg: "Final Tomcat instances: {{ tomcat_unique_instances }}"

# ========================================
# STEP 2: Write PowerShell collector script to disk
# ========================================
- name: Write Tomcat data collector script to disk
  win_copy:
    dest: C:\Windows\Temp\tomcat_collect.ps1
    content: |
      param(
        [string]$CatalinaHome,
        [string]$CatalinaBase
      )

      $ErrorActionPreference = 'SilentlyContinue'

      $CATALINA_HOME = $CatalinaHome.Trim()
      $CATALINA_BASE = $CatalinaBase.Trim()

      if (-not $CATALINA_HOME -or $CATALINA_HOME -eq '') {
        Write-Output "CATALINA_HOME=none^^^CATALINA_BASE=none^^^PIDS=none^^^VERSION=unknown^^^CONFIG=not-found^^^BINDIR=^^^PORTS=none^^^CONFIG_PORTS=none^^^LOGPATH=not-found"
        exit 0
      }

      # ---- PIDs ----
      # Find all java processes that match this Tomcat instance
      $PIDs = @()
      $allJavaProcesses = Get-CimInstance Win32_Process -Filter "Name LIKE '%java%'"

      foreach ($proc in $allJavaProcesses) {
        $cmdLine = $proc.CommandLine
        if ($cmdLine -like '*Bootstrap*' -and $cmdLine -like '*catalina*') {
          $procHome = ""
          $procBase = ""

          if ($cmdLine -match '-Dcatalina\.home=([^\s"]+)') {
            $procHome = $matches[1]
          } elseif ($cmdLine -match '-Dcatalina\.home="([^"]+)"') {
            $procHome = $matches[1]
          }

          if ($cmdLine -match '-Dcatalina\.base=([^\s"]+)') {
            $procBase = $matches[1]
          } elseif ($cmdLine -match '-Dcatalina\.base="([^"]+)"') {
            $procBase = $matches[1]
          }

          if ([string]::IsNullOrEmpty($procBase)) {
            $procBase = $procHome
          }

          # Check if this process belongs to our instance
          if ($procHome -eq $CATALINA_HOME -and $procBase -eq $CATALINA_BASE) {
            $PIDs += $proc.ProcessId
          }
        }
      }

      $PIDS_STRING = if ($PIDs.Count -gt 0) { ($PIDs -join ',') } else { "none" }

      # ---- VERSION from catalina.bat ----
      $VERSION = "unknown"
      $CATALINA_BAT = Join-Path $CATALINA_HOME "bin\catalina.bat"

      if (Test-Path $CATALINA_BAT) {
        try {
          $versionOutput = cmd /c "`"$CATALINA_BAT`" version 2>&1"
          if ($versionOutput -match 'Server version:\s*Apache\s+Tomcat[/\s]*([0-9.]+)') {
            $VERSION = $matches[1]
          } elseif ($versionOutput -match 'Apache\s+Tomcat\s+version\s+([0-9.]+)') {
            $VERSION = $matches[1]
          }
        } catch {
          $versionJar = Join-Path $CATALINA_HOME "lib\catalina.jar"
          if (Test-Path $versionJar) {
            $jarInfo = Get-Item $versionJar
            $VERSION = $jarInfo.VersionInfo.FileVersion
            if ([string]::IsNullOrEmpty($VERSION) -or $VERSION -eq "0.0.0.0") {
              $VERSION = "unknown"
            }
          }
        }
      } else {
        $serverXml = Join-Path $CATALINA_BASE "conf\server.xml"
        if (Test-Path $serverXml) {
          $xmlContent = Get-Content $serverXml -Raw
          if ($xmlContent -match '<Server[^>]+port="[0-9]+') {
            $VERSION = "detected"
          }
        }
      }

      # ---- CONFIG PATH (server.xml) ----
      $CONFIG_PATH = "not-found"
      $SERVER_XML = Join-Path $CATALINA_BASE "conf\server.xml"
      if (Test-Path $SERVER_XML) {
        $CONFIG_PATH = $SERVER_XML
      }

      # ---- BIN DIRECTORY ----
      $BIN_DIR = Join-Path $CATALINA_HOME "bin"

      # ---- PORTS from runtime listening sockets ----
      $PORTS = @()
      foreach ($p in $PIDs) {
        $conns = Get-NetTCPConnection -OwningProcess $p -State Listen -ErrorAction SilentlyContinue
        foreach ($c in $conns) {
          if ($c.LocalPort) {
            $PORTS += $c.LocalPort
          }
        }
      }

      # Remove duplicates and sort
      $PORTS = @($PORTS | Select-Object -Unique | Sort-Object)
      $PORTS_STRING = if ($PORTS.Count -gt 0) { ($PORTS -join ',') } else { "none" }

      # ---- CONFIG PORTS from server.xml ----
      $CONFIG_PORTS = @()
      if ($CONFIG_PATH -ne "not-found" -and (Test-Path $CONFIG_PATH)) {
        [xml]$xml = Get-Content $CONFIG_PATH
        $connectors = $xml.SelectNodes("//Connector[@port]")
        foreach ($conn in $connectors) {
          if ($conn.port -match '^\d+$') {
            $CONFIG_PORTS += [int]$conn.port
          }
        }
      }
      $CONFIG_PORTS = @($CONFIG_PORTS | Select-Object -Unique | Sort-Object)
      $CONFIG_PORTS_STRING = if ($CONFIG_PORTS.Count -gt 0) { ($CONFIG_PORTS -join ',') } else { "none" }

      # ---- LOG PATH ----
      $LOG_PATH = "not-found"
      $logLocations = @(
        (Join-Path $CATALINA_BASE "logs"),
        (Join-Path $CATALINA_HOME "logs")
      )
      foreach ($loc in $logLocations) {
        if (Test-Path $loc) {
          $LOG_PATH = $loc
          break
        }
      }

      # ---- SERVICE NAME (if running as Windows service) ----
      $SERVICE_NAME = "not-found"
      $allSvcs = Get-CimInstance Win32_Service -Filter "Name LIKE '%Tomcat%' OR DisplayName LIKE '%Tomcat%'" -ErrorAction SilentlyContinue
      foreach ($s in $allSvcs) {
        $sPath = $s.PathName -replace '"', ''
        if ($sPath -like "*$CATALINA_HOME*") {
          $SERVICE_NAME = $s.Name
          break
        }
      }

      # ---- JVM OPTIONS ----
      # FIX: Store regex patterns in variables to avoid quote escaping issues
      $JVM_OPTS = ""
      if ($PIDs.Count -gt 0) {
        $FIRST_PID = $PIDs[0]
        $proc = Get-CimInstance Win32_Process -Filter "ProcessId = $FIRST_PID"
        if ($proc) {
          $cmdLine = $proc.CommandLine
          $opts = @()
          $xmsPattern = '-Xm[sx][^\s]+'
          $xxPattern  = '-XX:[^\s]+'
          if ($cmdLine -match $xmsPattern) {
            $opts += $matches[0]
          }
          if ($cmdLine -match $xxPattern) {
            $opts += $matches[0]
          }
          $JVM_OPTS = ($opts | Select-Object -First 5) -join '###'
        }
      }

      Write-Output "CATALINA_HOME=$CATALINA_HOME^^^CATALINA_BASE=$CATALINA_BASE^^^PIDS=$PIDS_STRING^^^VERSION=$VERSION^^^CONFIG=$CONFIG_PATH^^^BINDIR=$BIN_DIR^^^PORTS=$PORTS_STRING^^^CONFIG_PORTS=$CONFIG_PORTS_STRING^^^LOGPATH=$LOG_PATH^^^SERVICE=$SERVICE_NAME^^^JVMOPTS=$JVM_OPTS"
  changed_when: false

# ========================================
# STEP 3: Execute the script for each instance
# ========================================
- name: Debug - Show instance being processed
  debug:
    msg: "Processing Tomcat instance: {{ item }}"
  loop: "{{ tomcat_unique_instances }}"
  when: tomcat_unique_instances | length > 0

- name: Collect all data for each unique Tomcat instance
  win_shell: |
    $parts = '{{ item }}' -split '\|'
    $catalinaHome = $parts[0]
    $catalinaBase = if ($parts.Length -gt 1) { $parts[1] } else { $parts[0] }
    & 'C:\Windows\Temp\tomcat_collect.ps1' -CatalinaHome $catalinaHome -CatalinaBase $catalinaBase
  args:
    executable: powershell.exe
  register: tomcat_data_collection
  changed_when: false
  failed_when: false
  loop: "{{ tomcat_unique_instances }}"
  when: tomcat_unique_instances | length > 0

- name: Debug - Show data collection results
  debug:
    msg: "stdout: [{{ item.stdout | default('EMPTY') }}] | rc: {{ item.rc | default('?') }}"
  loop: "{{ tomcat_data_collection.results | default([]) }}"
  when: tomcat_unique_instances | length > 0

# ========================================
# STEP 4: Clean up temp script
# ========================================
- name: Remove temp collector script
  win_file:
    path: C:\Windows\Temp\tomcat_collect.ps1
    state: absent
  changed_when: false
  failed_when: false

# ========================================
# STEP 5: Parse into JSON
# ========================================
- name: Initialize discovery array
  set_fact:
    discovery_array: []

- name: Parse each instance
  set_fact:
    discovery_array: "{{ discovery_array + [json_instance] }}"
  vars:
    data_line: "{{ item.stdout_lines | select('search', '^CATALINA_HOME=') | list | first | default('') }}"

    catalina_home: "{{ (data_line | regex_search('CATALINA_HOME=([^^]+)', '\\1') or [''])[0] | trim }}"
    catalina_base: "{{ (data_line | regex_search('CATALINA_BASE=([^^]+)', '\\1') or [''])[0] | trim }}"
    pids_raw:       "{{ (data_line | regex_search('PIDS=([^^]+)', '\\1') or [''])[0] | trim }}"
    version:        "{{ (data_line | regex_search('VERSION=([^^]+)', '\\1') or ['unknown'])[0] | trim }}"
    config_path:    "{{ (data_line | regex_search('CONFIG=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    bin_dir:        "{{ (data_line | regex_search('BINDIR=([^^]+)', '\\1') or [''])[0] | trim }}"
    ports_raw:      "{{ (data_line | regex_search('PORTS=([^^]+)', '\\1') or ['none'])[0] | trim }}"
    config_ports_raw: "{{ (data_line | regex_search('CONFIG_PORTS=([^^]+)', '\\1') or ['none'])[0] | trim }}"
    log_path:       "{{ (data_line | regex_search('LOGPATH=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    service_name:   "{{ (data_line | regex_search('SERVICE=([^^]+)', '\\1') or ['not-found'])[0] | trim }}"
    jvm_opts:       "{{ (data_line | regex_search('JVMOPTS=([^^]+)', '\\1') or [''])[0] | trim }}"

    pids_array:         "{{ pids_raw.split(',') | map('int', default=0) | list if pids_raw not in ['', 'none'] else [] }}"
    ports_array:        "{{ ports_raw.split(',') | map('int', default=0) | list if ports_raw not in ['', 'none'] else [] }}"
    config_ports_array: "{{ config_ports_raw.split(',') | map('int', default=0) | list if config_ports_raw not in ['', 'none'] else [] }}"

    json_instance:
      service_type: "MIDDLEWARE"
      service_name: "tomcat"
      service_version: "{{ version }}"
      port: "{{ ports_array[0] if ports_array | length > 0 else None }}"
      pid:  "{{ pids_array[0] if pids_array | length > 0 else 0 }}"
      paths:
        binary_path: "{{ bin_dir }}\\catalina.bat"
        config_path: "{{ config_path if config_path != 'not-found' else None }}"
        data_path:   "{{ catalina_base }}"
        log_path:    "{{ log_path if log_path != 'not-found' else None }}"
      additional_details:
        all_ports:        "{{ ports_array }}"
        all_pids:         "{{ pids_array }}"
        catalina_home:    "{{ catalina_home }}"
        catalina_base:    "{{ catalina_base }}"
        configured_ports: "{{ config_ports_array }}"
        windows_service:  "{{ service_name if service_name != 'not-found' else None }}"
        jvm_options:      "{{ jvm_opts if jvm_opts != '' else None }}"
      status: "{{ 'RUNNING' if pids_array | length > 0 else 'STOPPED' }}"
  loop: "{{ tomcat_data_collection.results | default([]) }}"
  when:
    - item.stdout is defined
    - item.stdout | trim != ''
    - item.stdout_lines | select('search', '^CATALINA_HOME=') | list | length > 0

#################################################################
# Append Tomcat services to global discovered_services
#################################################################
- name: Append Tomcat services to discovered_services
  set_fact:
    discovered_services: "{{ discovered_services + (discovery_array | default([])) }}"

- name: Display discovery summary
  debug:
    msg: "Tomcat Discovery: {{ discovery_array | length }} instance(s) found on {{ inventory_hostname }}"