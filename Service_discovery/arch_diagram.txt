                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚            API             â”‚
                 â”‚  /getNextBatchOfHosts      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ (Batch JSON)
                               â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚ AWX Inventory     â”‚
                     â”‚ Dynamic Source    â”‚
                     â”‚ (Custom Script)   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                      Inventory Sync
                               â”‚
                               â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚      AWX Job Template    â”‚
                â”‚  Runs Playbook on Batch  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                       Job Output
                            â”‚
                            â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚      AWX Workflow        â”‚
                â”‚  Decision Node: has_more â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                             â”‚
             â–¼                             â–¼
  If has_more == true               If has_more == false  
Repeat Loop                         Stop Workflow  
(next batch)                        (complete)



âœ… PART 1 â€” Where to create the Dynamic Inventory Script (UI steps)
Step 1: Go to AWX â†’ Settings

Left menu â†’ Settings

Step 2: Open Inventory Scripts

Settings â†’ Inventory Scripts

Step 3: Click â€œAddâ€

Create a new script:
âœ” Set a name (e.g., DynamicBatchInventory)
âœ” Paste your Python script
âœ” Save

This creates a reusable script.

âœ… PART 2 â€” How to Create a Custom Inventory Source using this Script
Steps:

Go to Inventories

Open or create a new Inventory

Go to Sources

Click Add Source

Select:

Source Type â†’ Custom Script

Script â†’ DynamicBatchInventory

Enable:
âœ” Update on Launch
âœ” Overwrite
âœ” Replace

Save

This Inventory Source will now call your script whenever you sync or run a job.

âœ… PART 3 â€” Batch-Based Dynamic Inventory Script (Your Requirement)

Below is a fully working, clean, and AWX-compatible script.

âœ” Fetches only one batch per API call
âœ” Returns only batch hosts
âœ” Adds metadata (batch_id, has_more)
âœ” AWX updates automatically before each job
ğŸŸ¢ âœ” FULL READY SCRIPT â€” COPY/PASTE INTO AWX
#!/usr/bin/env python3
import requests
import json
import sys

API_URL = "https://example.com/api/nextBatch"
API_TOKEN = "YOUR_TOKEN_HERE"

def fetch_batch():
    headers = {
        "Accept": "application/json",
        "Authorization": f"Bearer {API_TOKEN}"
    }

    try:
        response = requests.get(API_URL, headers=headers, timeout=30)
        response.raise_for_status()
        batch = response.json()
    except Exception as e:
        print(json.dumps({
            "_meta": {"error": str(e)}
        }))
        sys.exit(1)

    hosts = batch.get("hosts", [])
    batch_id = batch.get("batch_id", 0)
    has_more = batch.get("has_more", False)

    inventory = {
        "all": {
            "hosts": hosts,
            "vars": {
                "batch_id": batch_id,
                "has_more": has_more
            }
        },
        "_meta": {
            "hostvars": {host: {} for host in hosts}
        }
    }

    return inventory


if __name__ == "__main__":
    inv = fetch_batch()
    print(json.dumps(inv))

ğŸ“ PART 4 â€” Expected API Format

Your API must return something like:

{
  "batch_id": 3,
  "hosts": ["srv101", "srv102", "srv103"],
  "has_more": true
}


Or for the last batch:

{
  "batch_id": 10,
  "hosts": [],
  "has_more": false
}

ğŸš€ PART 5 â€” Using It in a Workflow (Batch Loop)

Workflow structure:

Inventory Sync â†’ Playbook Run â†’ Decision Node "has_more == true?" â†’ Loop


Your playbook can read:

- debug:
    msg: "Processing batch {{ hostvars['localhost']['batch_id'] }}"


Decision Node Expression:

hostvars.localhost.has_more == true


If true â†’ go back to Inventory Sync
If false â†’ stop workflow